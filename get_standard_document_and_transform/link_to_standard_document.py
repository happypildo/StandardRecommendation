RELEASE_TEXT = {
    4: """
    Details of the features and work items under each 3GPP Release are kept in the corresponding, on-line, list of features and study items.

A 3GPP description document - Overview of 3GPP Release 4 is available on-line, giving a high-level view of the features that are included in the Release.

3G Release 4 - See version 4 of ’Technical Specifications and Technical Reports for a UTRAN-based 3GPP system’, TR 21.101.
GSM/EDGE, Phase 2+ Release 4 - See Version 4 of ’Technical Specifications and Technical Reports for a GERAN-based 3GPP system’, TR 41.101.
See a short video/tutorial about release features.
    """,

    5: """
    Details of the features and work items under each 3GPP Release are kept in the corresponding, on-line, list of features and study items.

A 3GPP description document - Overview of 3GPP Release 5 is available on-line, giving a high-level view of the features that are included in the Release.

3G Release 5 - See version 5 of ’Technical Specifications and Technical Reports for a UTRAN-based 3GPP system’, TR 21.101.
GSM/EDGE, Phase 2+ Release 5 - See Version 5 of ’Technical Specifications and Technical Reports for a GERAN-based 3GPP system’, TR 41.101.
See a short video/tutorial about Release 5.
    """,

    6: """
    Details of the features and work items under each 3GPP Release are kept in the corresponding, on-line, list of features and study items.

A 3GPP description document - Overview of 3GPP Release 6 is available on-line, giving a high-level view of the features that are included in the Release.

3G Release 6 - See version 6 of ’Technical Specifications and Technical Reports for a UTRAN-based 3GPP system’, TR 21.101.
GSM/EDGE, Phase 2+ Release 6 - See Version 6 of ’Technical Specifications and Technical Reports for a GERAN-based 3GPP system’, TR 41.101.
See a short video/tutorial about Release 6.
    """,

    7: """
    Details of the features and work items under each 3GPP Release are kept in the corresponding, on-line, list of features and study items.

A 3GPP description document - Overview of 3GPP Release 7 is available on-line, giving a high-level view of the features that are included in the Release.

3G Release 7 - See version 7 of ’Technical Specifications and Technical Reports for a UTRAN-based 3GPP system’, TR 21.101.
GSM/EDGE, Phase 2+ Release 7 - See Version 7 of ’Technical Specifications and Technical Reports for a GERAN-based 3GPP system’, TR 41.101.
See a short tutorial about release 7.
    """,

    8: """
    Details of the features and work items under each 3GPP Release are kept in the corresponding, on-line, list of features and study items.

A 3GPP description document - Overview of 3GPP Release 8 is available on-line, giving a high-level view of the features that are included in the Release.

More on Release 8
3G Release 8 - See version 8 of "Technical Specifications and Technical Reports for a UTRAN-based 3GPP system", 3GPP TR 21.101
GSM/EDGE, Phase 2+ Release 8 - See Version 8 of "Technical Specifications and Technical Reports for a GERAN-based 3GPP system", 3GPP TR 41.101
See a short video/tutorial on Rel-8
    """,

    9: """
    Details of the features and work items under each 3GPP Release are kept in the corresponding, on-line, list of features and study items.

A 3GPP description document - Overview of 3GPP Release 9 is available on-line, giving a high-level view of the features that are included in the Release.

More on Release 9
See a short video/tutorial on Rel-8 and Rel-9
Release 9 introduces the complete integration of the Femtocell concept (Home eNodeB) and evolved important features such as self organising networks (SON), evolved multimedia broadcast and multicast service (eMBMS), positioning support (LCS) and also added new spectrum bands (e.g., 800 MHz and 1500 MHz) for LTE operation.

Functional freeze date including stable protocols: March 2010 (...what does this mean?)
    """,

    10: """
    Details of the features and work items under each 3GPP Release are kept in the corresponding, on-line, list of features and study items.


A 3GPP description document - Overview of 3GPP Release 10 is available on-line, giving a high-level view of the features that are included in the Release.

More reading and viewing on Release 10
LTE-Advanced (3GPP Release 10 and beyond), RF aspects,Takaharu Nakamura, 3GPP TSG-RAN-WG4 Chairman, December 2009.
LTE-Advanced article, updated June 2013.
Functional freeze date including stable protocols: September 2011 (...what does this mean?)
    """,

    11: """
    Details of the features and work items under each 3GPP Release are kept in the corresponding, on-line, list of features and study items.

A 3GPP description document - Overview of 3GPP Release 11 is available on-line, giving a high-level view of the features that are included in the Release.

Some Background on Release 11
A presentation delivered in June 2013, Identified the advances made in Release 11

Functional freeze date including stable protocols: March 2013 (...what does this mean?)
    """,

    12: """
    Release 12 was largely completed on-time in March 2015, with a few exceptional features allowed an extension to later in the year.

A priority in this realese was the use of LTE technology for emergency and security services, with technical specifications for mission-critical application layer functional elements and interfaces being developed in the newly formed SA6 working group. Work advanced well in this release with further progress, on Mission-Critical Press-to-Talk (MC-PTT) and other features, scheduled in Release 13.

Other important features completed in Release 12 include: Small cells and Network densification, D2D, LTE TDD-FDD joint operation including Carrier Aggregation, Security Assurance Methodology (SECAM) for 3GPP Nodes and the integration of WiFi in to mobile operator's offerings.

A 3GPP description document - Overview of 3GPP Release 12 is available on-line, giving a high-level view of the features that are included in the Release.

Some additional background material about the lead-up to Release 12 is on line at;

Video - "3GPP Status of Rel-12 and Rel-13" (Sept. 2014)
Understanding 3GPP Release 12 Standards by 4G Americas (Feb. 2015)
Video on 'Release 12 Prioritization' (Sept. 2013)
Future-Radio-in-3GPP - RAN Workshop news story (Jun. 2012)
New opportunities for 3GPP - SA Workshop news story on Rel-12 (Dec. 2012)
2020 vision for LTE, an article by Keith Mallinson (Jun. 2012)
Details of the features and work items under each 3GPP Release are kept in the corresponding, on-line, list of features and study items.

Functional freeze date including stable protocols: March 2015
    """,

    13: """
    Release 13 comprises around 170 high-level features and studies.

In addition to enhancements to existing services and features, this release saw the completion of the first set of specifications covering mission-critical services, in particular mission-critical Push-To-Talk, the essential functionality for LTE to be used by ‘blue light’ services for private mobile radio voice communication.

A study was also completed on ‘isolated E-UTRAN operation’ (i.e. mobile-to-mobile) for public safety use, and the architecture for supporting emergency services over wireless local area networks was investigated.
Image
"In this release we have a diverse set of projects, the largest is the MC-PTT protocol area, requiring a tremendous effort to take in members of a whole different market segment." Erik Guttman (3GPP SA Chairman 2015-2019)
Work continued on security issues to ensure that new services are free from the threat of hacking, denial of service attacks etc. For the first time, serious investigations were conducted into network virtualisation and how this might be realised in the context of a 3GPP network.

3GPP continued to work on the characterisation of carrier aggregation across additional band combinations to provide increased bandwidth within the limited frequency allocations to individual operators. Radio propagation was further improved by studies on Multiple-Input Multiple-Output antennas for both uplink and downlink, and on ever more sophisticated beam-forming.

A number of studies were conducted into the use of shared, unlicensed spectrum (particularly the 5 GHz Industrial, Scientific and Medical band), and a workshop was held in Beijing, China, to consider the designing of co-existence mechanisms for LTE to operate in unlicensed spectrum. This event did much to allay fears that Wi-Fi services might be negatively impacted by LTE in unlicensed spectrum.

Work then began on specifications to complement LTE coverage over a licensed Primary Component Carrier via a Secondary Component Carrier using unlicensed spectrum.

Other major advances achieved with the freezing of Release 13 included enhancements to machine-type communications, public safety features, small cell dual-connectivity and architecture, indoor positioning, single cell point-to-multipoint and work on latency reduction.
"Rel-13 is very important for 3GPP, with a lot of interesting features, such as LTE in unlicensed and LTE / WiFi integration and other features for new segments - including the IoT story - as well as features like D2D and initial studies on V2V, etc. Release 13 is a big release, improving efficiency and also expanding it to a set of new services, new verticals, going forward." Dino Flore (3GPP RAN Chairman 2013 - 2017)
Following a workshop in Phoenix, US, at which companies were able to share their views on the subject, in 2015 3GPP began work on the next generation cellular technology, or ‘5G’, with the aim of submitting a candidate technology to the IMT-2020 process.

Meanwhile, work started on Release 14 and, at the end of the year, over 50 features and studies had been defined including Multimedia Broadcast Supplement for Public Warning Systems, mission-critical video and mission-critical data services, LTE support for Vehicle-toAnything (V2X), latency reduction, high power LTE for certain bands, channel modelling for LTE in bands above 6 GHz, robust call set-up for Voice over LTE (VoLTE) and next generation access technologies.

A 3GPP description document - Overview of 3GPP Release 13 - is available on-line, giving a high-level view of the features that are included in the Release.

"LTE-Advanced Pro Ready to Go"
October 28, 2015
3GPP has approved a new LTE marker that will be used for the appropriate specifications from Release 13 onwards.

LTE-Advanced Pro will allow mobile standards users to associate various new features – from the Release’s freeze in March 2016 – with a distinctive marker that evolves the LTE and LTE-Advanced technology series.

Image
Details of the features and work items under each 3GPP Release are kept in the corresponding, on-line, list of features and study items.
    """,

    14: """
    Release 14 focuses on the following Features:

(source TR 21.914)

Improvements of the Mission Critical (MC) aspects, in particular by introducing Video and Data MC services.
Introducing Vehicle-to-Everything (V2X) communications, in particular Vehicle-to-Vehicle (V2V).
Improvements of the Cellular Internet of Things (CIoT) aspects, with 2G, 3G and 4G support of Machine-Type of Communications (MTC).
Improvements of the radio interface, in particular by enhancing the aspects related to coordination with WLAN and unlicensed spectrum.
A set of uncorrelated improvements, e.g. on Voice over LTE (VoLTE), IMS, Location reporting. 


Release description
The "Release 14 Description; Summary of Rel-14 Work Items" (TR21.914) is now available, with the Work Plan manager's summary notes for each of the Features within.  Although the detailed data on each piece of work (Studies, Work item descriptions, Features) is available via the work plan, or via the 3GPP Portal, we hope that the "initial state" (pre-Change Request state) of the Features in TR21.914 will be of use to you.  
    """,

    15: """
    After initial delivery in late 2017 of ‘Non-Stand-Alone’ (NSA) NR new radio specifications for 5G, much effort focused in 2018 on timely completion of 3GPP Release 15 – the first full set of 5G standards – and on work to pass the first milestones for the 3GPP submission towards IMT-2020.
While initial specifications enabled non-standalone 5G radio systems integrated in previous-generation LTE networks, the scope of Release 15 expands to cover ‘standalone’ 5G, with a new radio system complemented by a next-generation core network. It also embraces enhancements to LTE and, implicitly, the Evolved Packet Core (EPC). This crucial way-point enables vendors to progress rapidly with chip design and initial network implementation during 2019.
Image
Image
stage of Release 16, often referred to informally as ‘5G Phase 2’. By the end of the year, 83 studies relating to Release 16 plus a further thirteen relating to Rel-17 were in progress, covering topics as diverse as Multimedia Priority Service, Vehicle-to- everything (V2X) application layer services, 5G satellite access, Local Area Network support in 5G, wireless and wireline convergence for 5G, terminal positioning and location, communications in vertical domains and network automation and novel radio techniques. Further studies were launched or progressed on security, codecs and streaming services, LAN interworking, network slicing and the IoT.

Other activities focused on broadening the applicability of 3GPP technology to non-terrestrial radio access systems – from satellites and airborne base stations to maritime applications including ship-to-shore and ship-to-ship communications. Work also progressed on new Professional Mobile Radio (PMR) functionality for LTE, enhancing railway-oriented services originally developed using GSM radio technology which is now nearing its end of life.

(Source: ETSI Annual report 2018)
A full release description
The "Release 15 Description; Summary of Rel-15 Work Items" (TR21.915) is now available, with the Work Plan manager's summary notes for each of the Features within.  Although the detailed data on each piece of work (Studies, Work item descriptions, Features) is available via the work plan, or via the 3GPP Portal, we hope that the "initial state" (pre-Change Request state) of the Features in TR21.915 will be of use to you.  

Further reading:
RAN adjusts schedule for 2nd wave of 5G specifications
5G-NR workplan for eMBB
    """,

    16: """
    At the TSG#88e Plenary meetings - ending July 3, 2020 - Release 16 was completed with both the Stage 3 freeze and the ASN.1 and OpenAPI specification freeze being approved.

2019 nr schedule late drop pic3

A full release description
The "Release 16 Description; Summary of Rel-16 Work Items" (TR21.916) is now available, with the Work Plan manager's summary notes for each of the Features within.  Although the detailed data on each piece of work (Studies, Work item descriptions, Features) is available via the work plan, or via the 3GPP Portal, we hope that the "initial state" (pre-Change Request state) of the Features in TR21.916 will be of use to you. 
March 23, 2020 Update:
A shift of the Rel-16 timeline was approved at TSG#87 plenary e-meetings:

Rel-16 Stage 3 freeze now June 2020 (shifted by 3 months)

Rel-16 ASN.1 and OpenAPI specification freeze will also be complete in June 2020 (stays as planned)

Early Release 16 Status

Release 16 is a major release for the project, not least because it brings our IMT-2020 submission - for an initial full 3GPP 5G system - to its completion (see details below).

In addition to that formal process, work has progressed on around 25 Release 16 studies, on a variety of topics: Multimedia Priority Service, Vehicle-to-everything (V2X) application layer services, 5G satellite access, Local Area Network support in 5G, wireless and wireline convergence for 5G, terminal positioning and location, communications in vertical domains and network automation and novel radio techniques. Further items being studied include security, codecs and streaming services, Local Area Network interworking, network slicing and the IoT. 

Technical Reports (the result of the study phase) have also been developed on broadening the applicability of 3GPP technology to non-terrestrial radio access (initially satellites, but airborne base stations are also to be considered) and to maritime aspects (intra-ship, ship-to-shore and ship-to-ship). Work also progresses on new PMR functionality for LTE, enhancing the railway-oriented services originally developed using GSM radio technology that is now nearing end of life. 

As part of Release 16, MC services are extended to address a wider business sector than the initial rather narrow public security and civil defence services for which they had originally been developed. If the same or similar standards can be used for commercial applications (from taxi dispatching to railway traffic management, and other vertical sector scenarios currently being investigated), this would bring enhanced reliability to those MC services through wider deployment, and reduced deployment costs due to economies of scale – to the benefit of all users. 

RAN efforts couldn't avoid a short delay in the Rel-16  schedule:

In December 2018, an adjustment was agreed at TSGs#82 - to allow a 3 month shift in the Functional freeze (of features) and the ASN.1 completion for both Release 15 and Release 16:
IMT-2020 - Final submission
Release 16 will be "5G phase 2" and will be completed in June 2020 (TSGs#88) - See adjustment noted above.

Original schedule:
Image
This Release will meet the ITU IMT-2020 submission requirements and the time-plan as outlined in RP-172101:

Details of the work plan - to meet agreed IMT-2020 submission timeplan:

Step 1: From Sep 2017 to Dec 2017, discussions in RAN ITU-R Ad-Hoc 
Calibration for self evaluation
Prepare and finalize initial description template information that is to be submitted to ITU-R WP 5D#29.
Step 2: From early 2018 to Sep 2018, targeting “update & self eval” submission in Sep 2018
Performance evaluation against eMBB, mMTC and URLLC requirements and test environments for NR and LTE features.
Update description template and prepare compliance template according to self evaluation results.
Provide description template, compliance template, and self evaluation results based on Rel-15 in Sep 2018.
Step 3: From Sep 2018 to June 2019, targeting “Final” submission in June 2019
Performance evaluation update by taking into account Rel-16 updates in addition to Rel-15
Update description template and compliance template to take into account Rel-16 updates in addition to Rel-15
Provide description template, compliance template, and self evaluation results based on Rel-15 and Rel-16 in June 2019.
Some Background on Release 16
A view from the engine room, a video interview with Lionel Morand (TSG CT Chair) covering the major role that Release 16 plays in delivering the full set of features for the 5G system.(July, 2020)
RAN Rel-16 progress and Rel-17 potential work areas (July 18, 2019)
Early progress on Rel-16 bands for 5G (April 2, 2019)
"Working towards full 5G in Rel-16"...See a webinar presentation (July 3, 2018)
Preparing the ground for IMT-2020
SA1 completes its study into 5G requirements
Service requirements for the 5G system (TS22.261)
Release 16 Description - TR21.916 (now available):
Another way to get details of the features and work items,by 3GPP Release, is on-line in the list of features and study items.
    """,

    17: """
    More 5G system enhancements are reaching maturity with the completion of Release 17.
Image
Release description
The "Release 17 Description; Summary of Rel-17 Work Items" (TR21.917) is now available, with the Work Plan manager adding summary notes for each of the Features within.  Although the detailed data on each piece of work (Studies, Work item descriptions, Features) is available via the work plan, or via the 3GPP Portal, we hope that the "initial state" (pre-Change Request state) of the Features in TR21.917 will be of use to you. 

2022 was the year in which Release 17 was functionally frozen – 3GPP’s first and only release completed remotely in its entirety, via email discussions and online sessions - due to the travel restrictions in place.

Some Release 17 highlights
TSG#95-e (March 2022) saw the completion of the Rel-17 functional freeze.

Some important Rel-17 projects were:

Sidelink enhancements,
Reduced capability (Redap) NR devices,
NR operation extended to 71GHz,
Further enhancements on MIMO for NR,
NR over Non terrestrial Networks (NTN),
IoT over NTN,
UE power saving enhancements for NR,
Enhancements to Integrated Access and Backhaul for NR,
Enhancement of RAN slicing for NR,
RF requirements enhancement for NR FR1,
RF requirements for NR FR2,
Coverage and positioning enhancements,
NR and slicing QoE,
Enhanced support of non-public networks,
Support for uncrewed aerial systems,
Support for edge computing in 5GC,
Proximity-based services in 5GS,
Access traffic steering, switch and splitting (ATSSS),
Network automation for 5G (Phase 2).
During 2022, Release 18 started its progress - becoming the main focus from June onwards.

Some Background on Release 17
3GPP Work Plan review at Plenary #94e (SP-211658)
Release 17 Update from SA2 - March 2021 - Lists the new Release-17 study items and work items, approved as the focus of further enhancements to the 5G system and enablers for new features and services.
Evolution towards 5G-Advanced - May 2021 - 'Release 17 on time...'
Press Release: "Release 17 timeline agreed" - December 14, 2020
News story on "5G in Release 17 – strong radio evolution" - December 14, 2019
TR21.917 the "Release description; Release 17", will be approved and published at the end of the Release. Prior to that, draft versions will be available.

Details of the features and work items under each 3GPP Release are contained in the Work plan.
    """,

    18: """
    The "Release 18 Description; Summary of Rel-18 Work Items" (TR21.918) is now in production, with the Work Plan manager adding summary notes for each of the Features within.  Although the detailed data on each piece of work (Studies, Work item descriptions, Features) is available via the work plan, or via the 3GPP Portal, we hope that the "initial state" (pre-Change Request state) of the Features in TR21.918 will be of use to you. 

Release 18 specifies further improvements of the 5G-Avanced system. These improvements consist both in enhancements of concepts/Features introduced in the previous Releases and in the introduction of new topics.

Key improvements to:

(source TR 21.918)

Further integrate Satellite (NTN) access (introduced in Rel-17) in the 5G System (5GS).
Support of Internet of Things (IoT), Machine-Type Communication (MTC), including by satellite coverage.
Sidelink, Proximity, Location and Positioning.
Supporting industrial needs (Verticals, Industries, Factories, Northbound APIs)
Multicast and Broadcast Services (MBS)
Network Slicing
Uncrewed Aerial Vehicles (UAV).             
New topics include:

Energy Efficiency (EE).
Artificial Intelligence (AI)/Machine Learning (ML).
eXtended, Augmented and Virtual Reality (XR, AR, VR), Immersive communications.
TSG Rel-18 timeline & content
Rel 18 timeline 650px vkf

Rel-18 content largely decided at the December 2021 TSGs (#94-e):

Image
The Rel-18 Work Plan
As new studies and the detailed specification work begins, the Work Plan will be the place to monitor the growth of Release 18. Every Plenary set of meetings sees a major update to the 3GPP Work Plan.

The latest Work Plan is always available for download at https://www.3gpp.org/specifications/work-plan 

Some Background on Release 18
Rel-18 Status and Rel-19 Progress in TSG RAN - Wanshi Chen, TSG RAN Chair (Nov. 2023)

Release 18 Status - Puneet Jain, TSG SA Chair (Nov. 2023)

TR21.918 the "Release description; Release 18", will be approved and published at the end of the Release. Prior to that, draft versions will be available

3GPP news article: Advanced plans for 5G (July 6, 2021)

3GPP Release 18 Overview - ATIS webinar February 2, 2023 - On replay
About the ‘5G Advanced’ logo
5G Advanced 3D Waves 350px
We now have an official 5G-Advanced logo, for use on 3GPP Reports and Specifications, from Release-18 onwards.

The decision to adopt the new marker was taken at the 3GPP Project Coordination Group (PCG#46-e Meeting) in April 2021. The PCG has considered and approved the use of distinct 3GPP markers since the completion of early LTE work in 2008, to help distinguish new release capabilities and the services that they bring.

Whether ‘LTE’ or ‘5G’, these markers have allowed the broader industry to achieve some clarity in their conversations about which 3GPP system they are referring to in a variety of conversations with partners and customers, as well as within the 3GPP community.

Guidelines for the use of the 5G-Advanced logo are found ...here.
    """,

    19: """
    Rel-19 Timeline
Release timeline newRel 19

Rel-19 content was decided at the December 2023 TSGs (#102):

The priority topics in Rel-19

Image
The Rel-19 Work Plan
The Work Plan will be the place to monitor the growth of Release 19.

The latest Work Plan is always available for download at https://www.3gpp.org/specifications/work-plan 


Some Background on Release 19
Rel-18 Status and Rel-19 Progress in TSG SA, Puneet Jain, TSG SA Chair (Nov. 2023)

Early Workshops on Release 19 (June 2023). At TSGs#100 the Plenaries started the process of deciding what will be in Rel-19. Over 500 presentations were submitted to the two dedicated workshops in Taipei. https://www.3gpp.org/news-events/3gpp-news/tsg-100-01

Advancing 5G towards 6G, TSDSI Workshops (Jan 2023)
https://www.3gpp.org/news-events/partner-news/tsdsi-workshops
TR21.919 the "Release description; Release 19", will be approved and published at the end of the Release. Prior to that, draft versions will be available. 
About the ‘5G Advanced’ logo
The official 5G-Advanced logo, for use on 3GPP Reports and Specifications, will again appear on Release 19 deliverables.

The decision to adopt the new marker (from Rel-18) was taken at the 3GPP Project Coordination Group (PCG#46-e Meeting) in April 2021. The PCG has considered and approved the use of distinct 3GPP markers since the completion of early LTE work in 2008, to help distinguish new release capabilities and the services that they bring.

Whether ‘LTE’ or ‘5G’, these markers have allowed the broader industry to achieve some clarity in their conversations about which 3GPP system they are referring to in a variety of conversations with partners and customers, as well as within the 3GPP community.

Guidelines for the use of the 5G-Advanced logo are found ...here.
    """,

    20: """
    Rel-20 5G Advanced endorsed deadlines (RP-240824 March ‘24): (assuming no delay of Rel-19)

TSG SA Stage 1 studies by June 2025
TSG SA Stage 2 freeze by September 2026
TSG CT Stage 3 freeze in March 2027
The TSG RAN freeze is not yet decided. If we add 18 months to the TSG RAN Rel-19 dates, we could assume (TBD): RAN Stage 3 freeze in March 2027
TSG Rel-20 timeline & content
Release timeline Rel 20

Rel-20 content to be decided in the 1H 2025.

The Rel-20 Work Plan
As new studies and the detailed specification work begin, the Work Plan will be the place to monitor the growth of Release 20.

The latest Work Plan is always available for download at https://www.3gpp.org/specifications/work-plan 

Some Background on Release 20
Introduction to 3GPP Release 19 and 6G Planning - Contains an introduction to the preparation for 6G in 3GPP. https://atis.org/webinars/introduction-to-3gpp-release-19-and-6g-planning/

Advancing 5G towards 6G, TSDSI Workshops (Jan 2023) https://www.3gpp.org/news-events/partner-news/tsdsi-workshops
TR21.920 the "Release description; Release 19", will be approved and published at the end of the Release. Prior to that, draft versions will be available. 
    """

}

import torch
from transformers import AutoTokenizer, AutoModel
import numpy as np
import networkx as nx
import matplotlib.pyplot as plt
import matplotlib.cm as cm

class StringToWordConnection:
    def __init__(self, release_num, keywords, weights, model_name="bert-base-uncased"):
        print(f"Loading model '{model_name}'...")
        self.tokenizer = AutoTokenizer.from_pretrained(model_name)
        self.model = AutoModel.from_pretrained(model_name)
        print("Model loaded successfully!")

        self.string = RELEASE_TEXT[release_num]
        self.release_num = release_num
        self.keywords = keywords
        self.weights = weights

    def get_embedding(self, text):
        inputs = self.tokenizer(text, return_tensors="pt", padding=True, truncation=True)
        with torch.no_grad():
            outputs = self.model(**inputs)
            cls_embedding = outputs.last_hidden_state[:, 0, :].squeeze(0)
        return cls_embedding.numpy()

    def calculate_similarity(self):
        string_embedding = self.get_embedding(self.string)
        keyword_embeddings = [self.get_embedding(keyword) for keyword in self.keywords]

        similarities = []
        for idx, keyword_embedding in enumerate(keyword_embeddings):
            similarity = np.dot(string_embedding, keyword_embedding) / (
                np.linalg.norm(string_embedding) * np.linalg.norm(keyword_embedding) + 1e-9
            )
            similarities.append(similarity * self.weights[idx])

        return similarities

    # def visualize_graph(self, scores, threshold=0.1):
    #     G = nx.Graph()
    #
    #     # Add nodes
    #     G.add_node(self.string, color="red")
    #     G.add_nodes_from(self.keywords, color="blue")
    #
    #     # Add edges
    #     for i, keyword in enumerate(self.keywords):
    #         if scores[i] >= threshold:
    #             G.add_edge(self.string, keyword, weight=scores[i])
    #
    #     # # Draw graph with circular layout
    #     # pos = nx.circular_layout(G)
    #     # colors = [G.nodes[node].get("color", "gray") for node in G.nodes]
    #     # nx.draw(G, pos, node_color=colors, font_size=10, edge_color="gray")
    #
    #     # Calculate node size based on edge weights
    #     node_weights = {}
    #     for node in G.nodes:
    #         # Sum of edge weights connected to this node
    #         node_weights[node] = sum([data["weight"] for _, _, data in G.edges(node, data=True)])
    #
    #     # Normalize node sizes for better visualization
    #     max_weight = max(node_weights.values()) if node_weights else 1
    #     node_sizes = [(node_weights[node] / max_weight) * 1000 for node in G.nodes]
    #     font_sizes = [10 + (node_weights[node] / max_weight) * 20 for node in G.nodes]  # Base size + scaling
    #
    #     # Draw graph with adjusted node sizes
    #     pos = nx.spring_layout(G)
    #     colors = [G.nodes[node].get("color", "gray") for node in G.nodes]
    #     nx.draw(G, pos, node_color=colors, node_size=node_sizes, edge_color="gray")
    #
    #     # Add specific labels to certain nodes
    #     # Use a dictionary to specify custom labels
    #     specific_labels = {
    #         key: value for key, value in zip(self.keywords, self.keywords)
    #     }
    #     specific_labels[self.string] = f"Release: {self.release_num}"
    #     # nx.draw_networkx_labels(G, pos, )
    #
    #     for i, (node, (x, y)) in enumerate(pos.items()):
    #         plt.text(
    #             x,
    #             y,
    #             s=specific_labels[node],
    #             fontsize=font_sizes[i],
    #             ha="center",
    #             va="center",
    #         )
    #
    #     # Draw edge weights
    #     edge_labels = nx.get_edge_attributes(G, "weight")
    #     nx.draw_networkx_edge_labels(G, pos, edge_labels={k: f"{v:.2f}" for k, v in edge_labels.items()})
    #
    #     # Add colorbar for gradient scale
    #     cmap = cm.get_cmap('coolwarm')  # You can try other colormaps like 'viridis', 'plasma', etc.
    #     normalized_weights = {node: weight / max_weight for node, weight in node_weights.items()}
    #     node_colors = [cmap(normalized_weights[node]) for node in G.nodes]
    #     sm = cm.ScalarMappable(cmap=cmap, norm=plt.Normalize(vmin=0, vmax=max_weight))
    #     sm.set_array([])
    #     plt.colorbar(sm, label="Node Weight (Gradient Scale)")
    #     plt.show()
    def visualize_graph(self, scores, threshold=0.1):
        """
        Visualizes the graph with node sizes and colors based on edge weights.
        Applies gradient coloring to nodes and includes a colorbar.

        :param scores: Similarity scores between the string and keywords.
        :param threshold: Minimum connection strength to display an edge.
        """
        G = nx.Graph()

        # Add nodes
        G.add_node(self.string, color="red")  # Main string node
        G.add_nodes_from(self.keywords, color="blue")  # Keywords

        # Add edges with weights
        for i, keyword in enumerate(self.keywords):
            if scores[i] >= threshold:
                G.add_edge(self.string, keyword, weight=scores[i])

        # Calculate node weights (sum of edge weights)
        node_weights = {}
        for node in G.nodes:
            node_weights[node] = sum([data["weight"] for _, _, data in G.edges(node, data=True)])

        # Normalize weights for visualization (0 to 1)
        max_weight = max(node_weights.values()) if node_weights else 1
        normalized_weights = {node: weight / max_weight for node, weight in node_weights.items()}

        # Generate colors using a colormap
        cmap = cm.get_cmap('coolwarm')  # You can try other colormaps like 'viridis', 'plasma', etc.
        node_colors = [cmap(normalized_weights[node]) for node in G.nodes]

        # Calculate node sizes
        node_sizes = [300 + normalized_weights[node] * 1000 for node in G.nodes]
        font_sizes = [10 + (node_weights[node] / max_weight) * 20 for node in G.nodes]

        # Draw graph
        fig, ax = plt.subplots(constrained_layout=True)
        pos = nx.spring_layout(G)  # Circular layout for the graph
        nx.draw(
            G, pos, node_color=node_colors, node_size=node_sizes, edge_color="gray", font_size=10
        )

        # Draw edge weights
        edge_labels = nx.get_edge_attributes(G, "weight")
        nx.draw_networkx_edge_labels(G, pos, edge_labels={k: f"{v:.2f}" for k, v in edge_labels.items()})
        specific_labels = {
            key: value for key, value in zip(self.keywords, self.keywords)
        }
        specific_labels[self.string] = f"Release: {self.release_num}"
        # nx.draw_networkx_labels(G, pos, )

        for i, (node, (x, y)) in enumerate(pos.items()):
            plt.text(
                x,
                y,
                s=specific_labels[node],
                fontsize=font_sizes[i],
                ha="center",
                va="center",
            )

        # Add colorbar for gradient scale
        sm = cm.ScalarMappable(cmap=cmap, norm=plt.Normalize(vmin=0, vmax=max_weight))
        sm.set_array([])  # Required to link ScalarMappable to the colorbar
        fig.colorbar(sm, label="Node Weight (Gradient Scale)", ax=plt.gca())  # Attach colorbar to current Axes

        # Get current size and calculate new height
        current_width, current_height = fig.get_size_inches()
        new_width = 12  # Desired width
        new_height = (new_width / current_width) * current_height  # Adjust height to maintain aspect ratio

        # Set new size
        fig.set_size_inches(new_width, new_height)
        plt.show()

    def process(self, threshold=0.1):
        """
        Processes the string and keywords to visualize their connection graph.

        :param string: Input string.
        :param keywords: List of keywords.
        :param threshold: Minimum connection strength to display an edge.
        """
        print("Calculating similarity...")
        scores = self.calculate_similarity()

        print("Visualizing connection graph...")
        self.visualize_graph(scores, threshold)


# Example usage
# Instantiate the class with a pre-trained transformer model
stwc = StringToWordConnection(
    release_num=18,
    keywords=["AI", "Machine Learning", "Data Science", "Innovation", "Nonterrestrial-Netowrk"],
    weights=[5, 2, 1, 0.5, 0.7],
    model_name="bert-base-uncased"
)

# Process and visualize
stwc.process(threshold=0.1)
